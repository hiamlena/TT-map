# Репозиторий Trans-Time (TT-map)

## Обзор
Веб-приложение для построения маршрутов с поддержкой большегрузов на Яндекс.Картах. Основная страница `index.html` подключает конфигурацию (`config.php`) и модульные скрипты (`assets/js/yandex.js`, `assets/js/boot.js`), отображает карту и UI для выбора транспорта, построения и сохранения маршрутов.

## Ключевые файлы и ответственность
- `index.html` — верстка и UI-контролы: выбор ТС, параметры грузовика, переключение слоев, сохранение/шаринг маршрутов, контейнер `#map` для карты. Подключает конфиг и оба JS-модуля. Встроенный скрипт управляет скрытием блока расширенных параметров.  
- `config.php` — отдает `window.TRANSTIME_CONFIG` с ключами Яндекс API, настройками карты и флагом `debug`. Проверяет Referer по списку доменов и отдаёт JS только для разрешенных хостов.  
- `assets/js/yandex.js` — основной современный код работы с API v2.1: динамически грузит SDK (`csp=true&coordorder=longlat&load=package.full`), инициализирует карту, MultiRoute, подсказки и обогащенные слои из GeoJSON (весовые рамки, ограничения для грузовиков, федеральные трассы и т.п.). Реализует сохранение/загрузку маршрутов в `localStorage`, шаринг через base64-хэш, открытие в Навигаторе, управление активными маршрутами и фильтрацию рамок по bbox активного маршрута.  
- `assets/js/boot.js` — более простая/наследуемая инициализация карты и маршрута: вызывает `ymaps.ready(init)`, строит обычный маршрут `ymaps.route` и подгружает `./data/frames.geojson` при включенном чекбоксе. Дублирует часть UI-логики кнопок и может конфликтовать с новым модулем.  
- `assets/js/core.js`, `router.js`, `app.js` — вспомогательные утилиты, подсказки, форматирование, маршрутизация (используются внутри `yandex.js`).  
- `data/` — GeoJSON-слои для карты. В наличии `federal.geojson`, `frames_ready.geojson`, `hgv_allowed.geojson`, `hgv_conditional.geojson`, `roads_ufo_hgv.geojson`; при этом `yandex.js` ожидает также `hgv_forbidden.geojson` и `clearance.geojson`, которых нет в каталоге.  
- Дополнительные страницы: `diag.html` (диагностика), `test.html` (вероятно демонстрация), `debug_scan.php`, `errors.js` (обработка ошибок), `sw.js` (service worker) и статические стили в `assets/css/style.css`.

## Особенности интеграции Яндекс.Карт
- Загрузка API происходит динамически из `assets/js/yandex.js` с параметрами `load=package.full` и `csp=true`, чтобы корректно работать под CSP. Ошибка загрузки обрабатывается через `toast` с сообщением.  
- Набор слоев управляется чекбоксами; данные тянутся с `LAYERS_BASE` (по умолчанию `/data`). Перед добавлением производится нормализация координат и присвоение ID.  
- Поддерживается режим «точки по пути» с маркерами `via`, MultiRoute с сортировкой альтернативных маршрутов, сохранение выбранной карты и зума в `localStorage`, ограничение рамок по bbox активного маршрута.

## Потенциальные риски и наблюдения
- Одновременное подключение `assets/js/yandex.js` и `assets/js/boot.js` может дублировать инициализацию карты/маршрута и событий UI; потребуется выбрать один подход или синхронизировать их, чтобы избежать гонок и двойного построения.  
- В каталоге `data/` отсутствуют файлы `hgv_forbidden.geojson` и `clearance.geojson`, на которые ссылается `assets/js/yandex.js`; чекбоксы для этих слоев будут выдавать 404 и тост «Нет данных слоя».  
- `config.php` содержит ключи API и жесткую проверку Referer; при запуске с других доменов или из файла может отдавать 403 и ломать загрузку конфигурации.  
- CSP может влиять на загрузку внешнего SDK; параметр `csp=true` учтен, но при жесткой директиве `script-src` потребуется whitelisting `https://api-maps.yandex.ru` и локальных модулей.
