<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Карта на Яндекс.Картах</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background-color: #f5f5f5;
      color: #1f1f1f;
    }

    main {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    header {
      padding: 16px;
      background: #ffffff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
      z-index: 1;
    }

    h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 700;
    }

    .status {
      margin-top: 8px;
      font-size: 14px;
      color: #444;
    }

    #map {
      flex: 1 1 auto;
      min-height: 320px;
      background: linear-gradient(135deg, #e8eef6 0%, #f9fbff 100%);
    }

    .warning {
      padding: 12px 16px;
      background: #fffbe6;
      color: #795100;
      border: 1px solid #ffe58f;
      border-radius: 6px;
      margin-top: 8px;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <main>
    <header>
      <h1>Yandex Maps</h1>
      <p class="status" id="status">Загрузка карты…</p>
      <p class="warning hidden" id="cspWarning">
        Скрипт карт заблокирован политикой CSP. Добавьте api-maps.yandex.ru в директиву
        <code>script-src</code> (или <code>script-src-elem</code>) и разрешите загрузку inline-скриптов,
        если используется nonce/sha256.
      </p>
    </header>
    <div id="map" role="presentation" aria-label="Карта"></div>
  </main>

  <script>
    (function () {
      const status = document.getElementById('status');
      const cspWarning = document.getElementById('cspWarning');
      const mapContainer = document.getElementById('map');
      const apiKey = 'YOUR_API_KEY_HERE'; // Замените на действительный API-ключ.
      const lang = 'ru_RU';
      const apiUrl = `https://api-maps.yandex.ru/v3/?apikey=${encodeURIComponent(apiKey)}&lang=${lang}`;

      const setStatus = (text, isError = false) => {
        status.textContent = text;
        status.style.color = isError ? '#c10015' : '#444';
      };

      const showCspHint = () => {
        cspWarning.classList.remove('hidden');
      };

      const handleError = (message, error) => {
        console.error(message, error);
        setStatus(message, true);
      };

      const initMap = async () => {
        try {
          await ymaps3.ready;
          const {YMap, YMapDefaultSchemeLayer, YMapDefaultFeaturesLayer} = ymaps3;

          const map = new YMap(mapContainer, {
            location: {
              center: [37.617635, 55.755814], // Москва
              zoom: 10,
            },
            theme: 'light',
          });

          map.addChild(new YMapDefaultSchemeLayer());
          map.addChild(new YMapDefaultFeaturesLayer());

          setStatus('Карта успешно загружена');
        } catch (error) {
          handleError('Не удалось инициализировать карту (проверьте API-ключ и сетевые ограничения).', error);
        }
      };

      const injectScript = () => {
        const script = document.createElement('script');
        script.src = apiUrl;
        script.async = true;
        script.crossOrigin = 'anonymous';

        script.onload = () => {
          setStatus('Инициализация карты…');
          initMap();
        };

        script.onerror = (event) => {
          const isCsp = event?.message?.includes('Content Security Policy') || event?.type === 'error';
          if (isCsp) {
            showCspHint();
          }
          handleError('Не удалось загрузить скрипт Яндекс.Карт. Проверьте подключение и настройки CSP.', event);
        };

        window.addEventListener('unhandledrejection', (event) => {
          const isBundleError = typeof event?.reason?.message === 'string' &&
            event.reason.message.includes('Failed to bundle');
          if (isBundleError) {
            handleError('Yandex Maps API вернул ошибку сборки (возможно, устаревший бандл).', event.reason);
          }
        });

        document.head.appendChild(script);
      };

      injectScript();
    })();
  </script>
</body>
</html>
