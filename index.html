<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Trans-Time — Построение маршрута</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0f1115" />
  <link rel="stylesheet" href="./assets/css/style.css?v=2025-11-07" />
  <script type="module" src="./errors.js"></script>
</head>
<body>
  <header class="tt-header">
    <h1>Trans-Time: Построение маршрута</h1>
  </header>
  <main class="tt-layout">
    <section class="tt-panel">
      <div class="tt-field-group">
        <label class="tt-label">Тип транспорта</label>
        <div class="tt-veh">
          <label class="tt-chip">
            <input type="radio" name="veh" value="car" /> Легковой
          </label>
          <label class="tt-chip">
            <input type="radio" name="veh" value="truck40" checked /> Грузовой ≤ 40 т
          </label>
          <label class="tt-chip">
            <input type="radio" name="veh" value="truckHeavy" /> Грузовой &gt; 40 т
          </label>
        </div>
      </div>
      <div class="tt-field">
        <input id="from" class="tt-input" placeholder="A Откуда (поиск по адресу)" />
      </div>
      <div class="tt-field">
        <input id="to" class="tt-input" placeholder="B Куда (поиск по адресу)" />
      </div>
      <div class="tt-actions">
        <button id="buildBtn" class="tt-btn tt-btn-primary" disabled>Построить маршрут</button>
        <button id="clearVia" class="tt-btn" disabled>Сбросить via-точки</button>
      </div>
      <details class="tt-details">
        <summary>Слои</summary>
        <div class="tt-layers">
          <label class="tt-toggle">
            <input type="checkbox" id="toggle-traffic" checked />
            <span>Пробки</span>
          </label>
          <label class="tt-toggle">
            <input type="checkbox" id="toggle-frames" />
            <span>Весовые рамки</span>
          </label>
          <label class="tt-toggle">
            <input type="checkbox" id="toggle-hgv-allowed" checked />
            <span>Доступно HGV</span>
          </label>
          <label class="tt-toggle">
            <input type="checkbox" id="toggle-hgv-conditional" />
            <span>Условия HGV</span>
          </label>
          <label class="tt-toggle">
            <input type="checkbox" id="toggle-federal" />
            <span>Федеральные трассы</span>
          </label>
        </div>
      </details>
      <p class="tt-note">Нажми на карту, чтобы добавить via-точку. Подсказки появляются при наведении на неактивные кнопки.</p>
      <div class="tt-saved-actions">
        <button id="saveRouteBtn" class="tt-btn">Сохранить</button>
        <button id="shareRouteBtn" class="tt-btn">Ссылка</button>
        <button id="openNavBtn" class="tt-btn">Навигатор</button>
      </div>
      <ul id="savedRoutesList" class="tt-saved-routes"></ul>
    </section>
    <section class="tt-map-wrap">
      <div id="map" class="tt-map"></div>
      <div id="routeList" class="tt-route-list" style="display: none;"></div>
      <div class="tt-legend">
        <span class="tt-legend-item legend-active"></span><span class="tt-legend-label">Активный</span>
        <span class="tt-legend-item legend-alt"></span><span class="tt-legend-label">Альтернативный</span>
        <span class="tt-legend-item legend-frames"></span><span class="tt-legend-label">Весовые рамки</span>
      </div>
    </section>
  </main>
  <script src="./config.php"></script>
  <script type="module" src="./assets/js/yandex.js?v=2025-11-07"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js').catch(()=>{});
    }
    (function(){
      if (!document.getElementById('__tt_toast_css')) {
        const st=document.createElement('style');
        st.id='__tt_toast_css';
        st.textContent='.toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:#0f1626;color:#e6e6e6;border:1px solid #2b2f3a;border-radius:10px;padding:10px 12px;max-width:90vw;z-index:9999;display:none}';
        document.head.appendChild(st);
      }
      const persistIds=['toggle-traffic','toggle-frames','toggle-hgv-allowed','toggle-hgv-conditional','toggle-federal'];
      document.addEventListener('DOMContentLoaded',()=>{
        persistIds.forEach(id=>{
          const el=document.getElementById(id);
          if(!el) return;
          const key='TT_'+id;
          const saved=localStorage.getItem(key);
          if(saved!==null) el.checked=saved==='1';
          el.addEventListener('change',()=>localStorage.setItem(key,el.checked?'1':'0'));
        });
        const t=document.getElementById('toggle-traffic');
        const applyTraffic=()=>window.__tt_setTraffic?.(t.checked);
        if(t){
          t.addEventListener('change',applyTraffic);
          if(window.ymaps&&ymaps.ready) ymaps.ready(applyTraffic); else window.addEventListener('load',applyTraffic);
        }
        const btn=document.getElementById('shareRouteBtn');
        if(btn){
          btn.addEventListener('click',()=>{
            const h=window.__tt_makeShareHash?.();
            if(!h) return (window.toast?.('Укажи A и B')||alert('Укажи A и B'));
            const url=location.origin+location.pathname+location.search+h;
            if(navigator.clipboard?.writeText) navigator.clipboard.writeText(url).catch(()=>{}); else {
              const ta=document.createElement('textarea');
              ta.value=url; ta.style.position='fixed'; ta.style.opacity='0';
              document.body.appendChild(ta); ta.focus(); ta.select();
              try{document.execCommand('copy');}catch{}
              document.body.removeChild(ta);
            }
            (window.toast?.('Ссылка скопирована')||alert('Ссылка скопирована'));
            history.replaceState(null,'',h);
          });
        }
      });
      function b64EncodeUnicodeObj(obj){
        const str=JSON.stringify(obj);
        if(window.TextEncoder){
          const bytes=new TextEncoder().encode(str);
          let bin='';
          for(let i=0;i<bytes.length;i++) bin+=String.fromCharCode(bytes[i]);
          return btoa(bin);
        }
        return btoa(unescape(encodeURIComponent(str)));
      }
      function b64DecodeUnicodeToObj(b64){
        try{
          const bin=atob(b64);
          if(window.TextDecoder){
            const bytes=new Uint8Array(bin.length);
            for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
            return JSON.parse(new TextDecoder().decode(bytes));
          }
          return JSON.parse(decodeURIComponent(escape(bin)));
        }catch{return null}
      }
      window.__tt_makeShareHash=function(){
        const from=document.getElementById('from')?.value?.trim()||'';
        const to=document.getElementById('to')?.value?.trim()||'';
        const veh=(document.querySelector('input[name="veh"]:checked')||{}).value||'';
        if(!from||!to) return '';
        const payload={from,to,veh};
        const enc=b64EncodeUnicodeObj(payload);
        return enc?'#share='+encodeURIComponent(enc):'';
      };
      let __tt_lastShare=null;
      async function applyShare(){
        const m=location.hash.match(/^#share=([^&]+)/);
        if(!m) return;
        const raw=m[1];
        if(raw===__tt_lastShare) return;
        __tt_lastShare=raw;
        const payload=b64DecodeUnicodeToObj(decodeURIComponent(raw));
        if(!payload) return (window.toast?.('Некорректная ссылка')||alert('Некорректная ссылка'));
        const fromEl=document.getElementById('from');
        const toEl=document.getElementById('to');
        if(fromEl) fromEl.value=payload.from||'';
        if(toEl) toEl.value=payload.to||'';
        if(payload.veh){
          document.querySelectorAll('input[name="veh"]').forEach(r=>{
            r.checked=(r.value===payload.veh);
            r.dispatchEvent(new Event('change'));
          });
        }
        if(!payload.from||!payload.to) return;
        try{
          if(typeof window.onBuild==='function') await window.onBuild();
          else if(typeof window.buildRoute==='function') await window.buildRoute();
          else document.getElementById('buildBtn')?.click();
        }catch{}
      }
      window.addEventListener('hashchange',applyShare);
      window.addEventListener('DOMContentLoaded',applyShare);
      (function(){
        const tryInit=()=>{
          if(!window.ymaps||!document.getElementById('from')) return;
          try{ new ymaps.SuggestView('from'); new ymaps.SuggestView('to'); }catch{}
        };
        if(window.ymaps&&ymaps.ready) ymaps.ready(tryInit); else window.addEventListener('load',tryInit);
      })();
    })();
  </script>
</body>
</html>