<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Trans-Time — Маршрут для грузовиков</title>
<style>
:root {
  --bg:#0f1115;
  --panel:#151822;
  --muted:#8892a6;
  --text:#e6eaf2;
  --accent:#e11d2e;
  --stroke:#232836;
  --btn:#1b2030;
  --btn-h:#232a36;
  --success:#22c55e;
  --alt:#f59e0b;
  --frame:#60a5fa;
}
* { box-sizing:border-box; }
html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font:14px/1.45 "Inter",system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; }
body { display:flex; flex-direction:column; }
#app { display:grid; grid-template-rows:auto 1fr; min-height:100vh; }
header { position:sticky; top:0; z-index:10; background:linear-gradient(180deg,var(--panel),rgba(21,24,34,.86)); border-bottom:1px solid var(--stroke); backdrop-filter:blur(6px); }
.bar { max-width:1200px; margin:8px auto; padding:8px 12px 12px; display:grid; gap:8px; grid-template-columns:auto 1fr auto; align-items:center; }
.brand { display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.3px; font-size:16px; }
.brand img { width:28px; height:28px; }
.small { font-size:12px; color:var(--muted); }
.panel-grid { width:100%; display:grid; gap:8px; grid-template-columns:1fr 1fr; }
.field { display:flex; gap:10px; align-items:center; padding:10px 12px; border-radius:12px; background:var(--btn); border:1px solid var(--stroke); box-shadow:inset 0 0 0 1px rgba(255,255,255,.02); }
.field span { text-transform:uppercase; font-size:11px; letter-spacing:.08em; color:var(--muted); }
.field input { flex:1; border:0; outline:none; font:14px/1.2 inherit; color:var(--text); background:transparent; }
.field input::placeholder { color:rgba(230,234,242,.55); }
.row2 { display:flex; gap:8px; align-items:center; grid-column:1/-1; flex-wrap:wrap; }
#vehicleGroup { display:flex; gap:8px; flex-wrap:wrap; }
.btnGroup { display:flex; gap:8px; }
.pill { display:inline-flex; align-items:center; gap:6px; padding:8px 14px; border-radius:999px; background:var(--btn); border:1px solid var(--stroke); cursor:pointer; user-select:none; transition:border-color .2s, background-color .2s, color .2s; }
.pill input { display:none; }
.pill.active { border-color:var(--accent); background:var(--btn-h); color:#fff; }
.btn { border:0; border-radius:12px; padding:11px 16px; font-weight:600; cursor:pointer; transition:background .2s, transform .2s; }
.btn.primary { background:var(--accent); color:#fff; }
.btn.secondary { background:var(--btn); color:var(--text); border:1px solid var(--stroke); }
.btn:disabled { opacity:.5; cursor:not-allowed; }
.btn:not(:disabled):active { transform:translateY(1px); }
main { position:relative; }
#map { width:100%; height:100%; min-height:calc(100vh - 160px); background:#000; }
.legend { position:absolute; left:16px; bottom:16px; z-index:4; background:rgba(21,24,34,.92); border:1px solid var(--stroke); border-radius:14px; padding:10px 14px; display:flex; gap:12px; align-items:center; box-shadow:0 12px 40px rgba(0,0,0,.45); }
.legend .item { display:flex; align-items:center; gap:8px; }
.legend .dot { width:12px; height:12px; border-radius:50%; }
#routeList { position:absolute; right:16px; top:120px; z-index:5; min-width:240px; max-width:320px; max-height:calc(100vh - 200px); overflow-y:auto; display:none; background:rgba(21,24,34,.94); border:1px solid var(--stroke); border-radius:14px; padding:10px; box-shadow:0 18px 48px rgba(0,0,0,.45); backdrop-filter:blur(6px); }
.routeItem { padding:10px; border-radius:12px; border:1px solid transparent; cursor:pointer; display:flex; flex-direction:column; gap:4px; transition:background .2s, border-color .2s; }
.routeItem:hover { background:var(--btn); }
.routeItem.active { border-color:var(--accent); background:rgba(225,29,46,.12); }
.routeItem .title { font-weight:600; }
.routeItem .meta { font-size:12px; color:var(--muted); }
#toast { position:fixed; right:18px; bottom:18px; z-index:20; padding:12px 16px; border-radius:14px; border:1px solid var(--stroke); background:rgba(21,24,34,.94); box-shadow:0 18px 48px rgba(0,0,0,.45); display:flex; gap:10px; align-items:flex-start; opacity:0; pointer-events:none; transform:translateY(12px); transition:opacity .3s ease, transform .3s ease; max-width:320px; }
#toast.show { opacity:1; pointer-events:auto; transform:translateY(0); }
@media (max-width:1100px) {
  .bar { grid-template-columns:1fr 1fr; }
  .bar .small:last-child { text-align:left; }
  #routeList { top:132px; }
}
@media (max-width:900px) {
  .bar { grid-template-columns:1fr; padding:8px 10px 12px; }
  .brand { font-size:15px; }
  .panel-grid { grid-template-columns:1fr; }
  .field { width:100%; }
  .row2 { flex-direction:column; align-items:stretch; gap:10px; }
  #vehicleGroup { width:100%; }
  .btnGroup { width:100%; display:flex; gap:8px; }
  .btnGroup .btn { flex:1; }
  #map { min-height:calc(100vh - 260px); }
  #routeList { top:auto; right:16px; left:16px; bottom:96px; max-width:none; width:auto; }
  #routeList::after { content:""; display:block; height:4px; }
  #toast { left:16px; right:16px; max-width:none; }
  .legend { left:16px; right:auto; bottom:16px; font-size:12px; flex-wrap:wrap; }
}
</style>
<script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU&apikey=317aa42d-aa15-4acf-885a-6d6bfddb2339&suggest_apikey=317aa42d-aa15-4acf-885a-6d6bfddb2339"></script>
</head>
<body>
<div id="app">
  <header>
    <div class="bar">
      <div class="brand">
        <img src="../assets/logo-tt.svg" alt="Trans-Time" loading="lazy"/>
        <span>Trans-Time • Маршрут для грузовиков</span>
      </div>
      <div class="small">Клик по карте → добавляет via‑точку</div>
      <div class="small" style="text-align:right">Альтернативы справа или снизу</div>
      <div class="panel-grid">
        <label class="field" for="from"><span>Откуда</span><input id="from" type="text" placeholder="Адрес, город" autocomplete="off"/></label>
        <label class="field" for="to"><span>Куда</span><input id="to" type="text" placeholder="Адрес, город" autocomplete="off"/></label>
      </div>
      <div class="row2">
        <div id="vehicleGroup">
          <label class="pill active"><input type="radio" name="veh" value="car" checked>Легковой</label>
          <label class="pill"><input type="radio" name="veh" value="truck40">Грузовой ≤ 40 т</label>
          <label class="pill"><input type="radio" name="veh" value="truckHeavy">Грузовой &gt; 40 т</label>
        </div>
        <div class="btnGroup" style="margin-left:auto; display:flex; gap:8px;">
          <button id="buildBtn" class="btn primary">Построить маршрут</button>
          <button id="clearVia" class="btn secondary">Сбросить via-точки</button>
        </div>
      </div>
    </div>
  </header>
  <main>
    <div id="map"></div>
    <div id="routeList"></div>
    <div class="legend">
      <div class="item"><span class="dot" style="background:var(--success);"></span><span class="small" style="color:var(--text);">Активный маршрут</span></div>
      <div class="item"><span class="dot" style="background:var(--alt);"></span><span class="small" style="color:var(--text);">Альтернативы</span></div>
      <div class="item"><span class="dot" style="background:var(--frame);"></span><span class="small" style="color:var(--text);">Весовые рамки</span></div>
    </div>
  </main>
</div>
<div id="toast"></div>
<script>
(function(){
  'use strict';

  let map, multiRoute, objectManager;
  const userViaPoints = [];
  const userViaMarks = [];
  let framePoints = [];
  let pendingDetours = [];
  let announceDetoursOnce = false;

  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  const fromInput = $('#from');
  const toInput = $('#to');
  const routeListEl = $('#routeList');
  const toastEl = $('#toast');

  const notifications = (() => {
    const queue = [];
    let timer = null;
    let active = false;
    const schedule = () => {
      if(!queue.length){
        active = false;
        toastEl.classList.remove('show');
        return;
      }
      active = true;
      const {html, ms} = queue.shift();
      toastEl.innerHTML = html;
      toastEl.classList.add('show');
      clearTimeout(timer);
      timer = setTimeout(() => {
        toastEl.classList.remove('show');
        timer = setTimeout(schedule, 220);
      }, ms);
    };
    return {
      push(html, ms = 4200){
        queue.push({html, ms});
        if(!active) schedule();
      },
      clear(){
        queue.length = 0;
        clearTimeout(timer);
        timer = null;
        active = false;
        toastEl.classList.remove('show');
      }
    };
  })();

  const setActivePill = (value) => {
    $$('#vehicleGroup .pill').forEach((pill) => {
      const input = pill.querySelector('input');
      pill.classList.toggle('active', input && input.value === value && input.checked);
    });
  };

  const getVehicleValue = () => document.querySelector('input[name="veh"]:checked')?.value || 'car';

  const getRoutingConfig = () => {
    const value = getVehicleValue();
    if(value === 'car') return {mode:'auto'};
    if(value === 'truck40') return {mode:'truck', truck:{weight:40000}};
    return {mode:'truck', truck:{weight:50000, axleCount:5}};
  };

  const fmtDist = (m = 0) => {
    if(!Number.isFinite(m) || m <= 0) return '—';
    const km = m / 1000;
    const precision = km >= 100 ? 0 : 1;
    return km.toFixed(precision).replace('.', ',') + ' км';
  };

  const fmtTime = (s = 0) => {
    if(!Number.isFinite(s) || s <= 0) return '—';
    const hours = Math.floor(s / 3600);
    const minutes = Math.round((s % 3600) / 60);
    if(minutes === 60){
      return `${hours + 1} ч 0 мин`;
    }
    return hours ? `${hours} ч ${minutes} мин` : `${minutes} мин`;
  };

  const escapeHtml = (str) => String(str ?? '').replace(/[&<>"']/g, (ch) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));

  ymaps.ready(init);

  function init(){
    map = new ymaps.Map('map', {
      center:[55.751244,37.618423],
      zoom:8,
      controls:['zoomControl','geolocationControl','typeSelector','fullscreenControl']
    }, {
      suppressMapOpenBlock:true
    });

    new ymaps.SuggestView('from', {results:8, width:'auto'});
    new ymaps.SuggestView('to', {results:8, width:'auto'});

    $$('#vehicleGroup input[name="veh"]').forEach((input) => {
      input.addEventListener('change', () => {
        setActivePill(input.value);
        if(fromInput.value && toInput.value) {
          buildRoute();
        }
      });
    });

    map.events.add('click', (event) => {
      const coords = event.get('coords');
      if(!coords) return;
      const label = `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
      if(window.confirm(`Добавить via-точку?\n${label}`)){
        userViaPoints.push(coords);
        const mark = new ymaps.Placemark(coords, {hintContent:'via-точка'}, {preset:'islands#blueDotIcon'});
        userViaMarks.push(mark);
        map.geoObjects.add(mark);
        if(fromInput.value && toInput.value){
          buildRoute();
        }
      }
    });

    $('#buildBtn').addEventListener('click', buildRoute);

    $('#clearVia').addEventListener('click', () => {
      userViaPoints.length = 0;
      while(userViaMarks.length){
        const placemark = userViaMarks.pop();
        if(placemark) map.geoObjects.remove(placemark);
      }
      notifications.push('Via-точки очищены');
      if(multiRoute) buildRoute();
    });

    ['from','to'].forEach((id) => {
      const input = $('#'+id);
      input.addEventListener('keydown', (e) => {
        if(e.key === 'Enter'){
          e.preventDefault();
          buildRoute();
        }
      });
    });

    loadFrames();
  }

  async function geocodeToPoint(query){
    if(Array.isArray(query) && query.length === 2) return query;
    const response = await ymaps.geocode(query, {results:1});
    const geoObject = response.geoObjects.get(0);
    if(!geoObject) throw new Error('Адрес не найден: ' + query);
    return geoObject.geometry.getCoordinates();
  }

  async function buildRoute(){
    const fromValue = fromInput.value.trim();
    const toValue = toInput.value.trim();
    if(!fromValue || !toValue){
      notifications.clear();
      notifications.push('Укажи <b>Откуда</b> и <b>Куда</b>.');
      return;
    }

    try {
      notifications.clear();
      const [start, finish] = await Promise.all([
        geocodeToPoint(fromValue),
        geocodeToPoint(toValue)
      ]);

      let referencePoints = [start, ...userViaPoints, finish];
      pendingDetours = [];
      announceDetoursOnce = false;

      if(framePoints.length && getVehicleValue() !== 'car' && referencePoints.length >= 2){
        const augmented = injectDetours(referencePoints.slice());
        referencePoints = augmented.points;
        pendingDetours = augmented.names;
        announceDetoursOnce = pendingDetours.length > 0;
      }

      const config = getRoutingConfig();
      const params = {results:3, routingMode:config.mode, avoidTrafficJams:true};
      if(config.truck) params.truck = config.truck;

      if(!multiRoute){
        multiRoute = new ymaps.multiRouter.MultiRoute({
          referencePoints,
          params
        }, {
          boundsAutoApply:true,
          routeActiveStrokeWidth:6,
          routeActiveStrokeColor:'#22c55e',
          routeStrokeStyle:'solid',
          routeStrokeWidth:3,
          routeStrokeOpacity:0.6,
          routeStrokeColor:'#f59e0b',
          wayPointStartIconFillColor:'#22c55e',
          wayPointFinishIconFillColor:'#ef4444',
          viaPointIconFillColor:'#60a5fa',
          wayPointDraggable:false
        });
        map.geoObjects.add(multiRoute);
        multiRoute.model.events.add('requestsuccess', updateUI);
        multiRoute.events.add('activeroutechange', updateUI);
        multiRoute.model.events.add('requestfail', () => {
          notifications.clear();
          notifications.push('Маршрут не построен. Проверь адреса и тип транспорта.', 5200);
        });
      } else {
        multiRoute.model.setReferencePoints(referencePoints);
        multiRoute.model.setParams(params, true);
      }

      routeListEl.innerHTML = '<div class="small">Строим маршрут…</div>';
      routeListEl.style.display = 'block';
    } catch (error) {
      console.warn(error);
      notifications.clear();
      notifications.push('Не удалось построить маршрут. Проверь адреса.', 5200);
    }
  }

  function injectDetours(points){
    const projection = ymaps.projection.wgs84Mercator;
    const insertedNames = [];
    for(const frame of framePoints){
      if(!Array.isArray(frame.coords)) continue;
      const nearest = findNearestSegment(points, frame.coords, projection);
      if(!nearest || !isFinite(nearest.distance) || nearest.distance > 100) continue;
      const azimuth = nearest.azimuth;
      const candidates = [azimuth + 90, azimuth - 90];
      let chosen = null;
      let bestSpacing = -Infinity;
      for(const angle of candidates){
        const normalized = normalizeAzimuth(angle);
        const candidate = ymaps.coordSystem.geo.solveDirectProblem(frame.coords, normalized, 200).endPoint;
        const spacing = ymaps.coordSystem.geo.getDistance(candidate, frame.coords);
        if(spacing > bestSpacing){
          bestSpacing = spacing;
          chosen = candidate;
        }
      }
      if(!chosen) continue;
      points.splice(nearest.index + 1, 0, chosen);
      insertedNames.push(frame.name);
    }
    return {points, names:insertedNames};
  }

  function findNearestSegment(points, target, projection){
    if(points.length < 2) return null;
    const targetGlobal = projection.toGlobal(target);
    let best = null;
    for(let i = 0; i < points.length - 1; i++){
      const start = points[i];
      const end = points[i + 1];
      const startGlobal = projection.toGlobal(start);
      const endGlobal = projection.toGlobal(end);
      const vx = endGlobal[0] - startGlobal[0];
      const vy = endGlobal[1] - startGlobal[1];
      const lengthSq = vx * vx + vy * vy;
      if(lengthSq === 0) continue;
      const px = targetGlobal[0] - startGlobal[0];
      const py = targetGlobal[1] - startGlobal[1];
      let t = (px * vx + py * vy) / lengthSq;
      t = Math.max(0, Math.min(1, t));
      const projGlobal = [startGlobal[0] + vx * t, startGlobal[1] + vy * t];
      const projGeo = projection.fromGlobal(projGlobal);
      const distance = ymaps.coordSystem.geo.getDistance(target, projGeo);
      if(!isFinite(distance)) continue;
      if(!best || distance < best.distance){
        const info = ymaps.coordSystem.geo.solveInverseProblem(start, end);
        const azimuth = info.forwardAzimuth;
        best = {distance, index:i, azimuth};
      }
    }
    return best;
  }

  function normalizeAzimuth(value){
    let v = value % 360;
    if(v < 0) v += 360;
    return v;
  }

  function updateUI(){
    if(!multiRoute) return;
    const routes = multiRoute.getRoutes();
    if(!routes || routes.getLength() === 0){
      routeListEl.style.display = 'none';
      notifications.push('Маршрут не найден.', 3800);
      return;
    }

    const activeRoute = multiRoute.getActiveRoute();
    if(activeRoute){
      const props = activeRoute.properties.getAll();
      notifications.push(`<b>Активный маршрут:</b> ${fmtDist(props?.distance?.value)} • ${fmtTime(props?.duration?.value)}`, 6200);
      if(announceDetoursOnce && pendingDetours.length){
        const uniqueNames = [...new Set(pendingDetours)].filter(Boolean);
        uniqueNames.forEach((name) => {
          notifications.push(`Объезд весовой рамки у ${escapeHtml(name)}`, 3600);
        });
        pendingDetours = [];
        announceDetoursOnce = false;
      }
    }

    routeListEl.innerHTML = '';
    for(let i = 0; i < routes.getLength(); i++){
      const route = routes.get(i);
      const props = route.properties.getAll();
      const item = document.createElement('div');
      item.className = 'routeItem' + (route === activeRoute ? ' active' : '');
      item.innerHTML = `<div class="title">Вариант ${i + 1}</div><div class="meta">${fmtDist(props?.distance?.value)} • ${fmtTime(props?.duration?.value)}</div>`;
      item.addEventListener('click', () => {
        multiRoute.setActiveRoute(route);
        updateUI();
      });
      routeListEl.appendChild(item);
    }
    routeListEl.style.display = 'block';
  }

  async function loadFrames(){
    try {
      const response = await fetch(`/TT-map/map/data/frames_ready.geojson?v=${Date.now()}`, {cache:'no-store'});
      if(!response.ok) throw new Error('frames_ready.geojson not found');
      const data = await response.json();

      objectManager = new ymaps.ObjectManager({clusterize:false, geoObjectOpenBalloonOnClick:true});
      objectManager.objects.options.set({preset:'islands#blueCircleDotIcon'});

      framePoints = [];
      if(Array.isArray(data?.features)){
        const features = [];
        data.features.forEach((feature, idx) => {
          if(feature?.geometry?.type !== 'Point' || !Array.isArray(feature.geometry.coordinates)) return;
          const [lon, lat] = feature.geometry.coordinates;
          if(!isFinite(lat) || !isFinite(lon)) return;
          const props = feature.properties || {};
          const name = props.name || props.title || props.id || `Рамка №${idx + 1}`;
          const comment = props.comment ? `<div style="margin-top:6px">${escapeHtml(props.comment)}</div>` : '';
          const date = props.date ? `<div class="small" style="margin-top:6px;color:#9aa3b2">Дата: ${escapeHtml(props.date)}</div>` : '';
          feature.properties = {
            hintContent: name,
            balloonContent: `<div style="min-width:220px"><b>${escapeHtml(name)}</b>${comment}${date}</div>`
          };
          features.push(feature);
          framePoints.push({coords:[lat, lon], name});
        });
        objectManager.add({type:'FeatureCollection', features});
      }

      if(objectManager) map.geoObjects.add(objectManager);
      notifications.push(`Загружено рамок: ${framePoints.length}`, 3200);
    } catch (error) {
      console.warn(error);
      notifications.push('Не удалось загрузить весовые рамки.', 4800);
    }
  }
})();
</script>
</body>
</html>
