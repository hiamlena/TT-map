<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Trans-Time ‚Ä¢ –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤</title>
<style>
:root {
  color-scheme: dark;
  --bg:#0f1115;
  --panel:#151822;
  --panel-soft:rgba(21,24,34,.92);
  --text:#e6eaf2;
  --muted:#9aa3b2;
  --accent:#e11d2e;
  --accent-hover:#f02c3e;
  --blue:#60a5fa;
  --stroke:#232836;
  --success:#22c55e;
  --warning:#f59e0b;
  --radius-lg:18px;
  --radius-md:12px;
  --radius-sm:10px;
  --shadow:0 20px 48px rgba(0,0,0,.45);
}
* { box-sizing:border-box; }
html,body { height:100%; margin:0; }
body {
  min-height:100vh;
  background:var(--bg);
  color:var(--text);
  font:15px/1.45 'Inter',system-ui,-apple-system,'Segoe UI',Roboto,Arial,sans-serif;
  display:flex;
  flex-direction:column;
  -webkit-font-smoothing:antialiased;
}
button,input { font:inherit; color:inherit; }
button { cursor:pointer; }
#app { display:flex; flex-direction:column; flex:1; min-height:0; }
header {
  position:sticky;
  top:0;
  z-index:40;
  background:linear-gradient(180deg,rgba(21,24,34,.96),rgba(15,17,21,.88));
  border-bottom:1px solid var(--stroke);
  backdrop-filter:blur(14px);
  box-shadow:0 18px 40px rgba(0,0,0,.35);
}
.bar {
  max-width:1280px;
  margin:0 auto;
  padding:18px clamp(16px,3vw,32px) 22px;
  display:flex;
  flex-direction:column;
  gap:16px;
}
.brand {
  display:flex;
  align-items:center;
  gap:12px;
  font-weight:600;
  letter-spacing:.02em;
  font-size:18px;
}
.brand img { width:34px; height:34px; }
.small-note { color:var(--muted); font-size:13px; }
.api-banner {
  display:none;
  padding:14px 16px;
  border-radius:var(--radius-md);
  border:1px solid rgba(225,29,46,.4);
  background:rgba(225,29,46,.14);
  color:#ffe6ea;
  font-size:13px;
  line-height:1.5;
}
.api-banner.show { display:block; }
.controls {
  display:flex;
  flex-direction:column;
  gap:16px;
}
.fields {
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:12px;
}
.field {
  background:var(--panel);
  border:1px solid var(--stroke);
  border-radius:var(--radius-lg);
  padding:12px 16px;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.field label {
  font-size:11px;
  letter-spacing:.09em;
  text-transform:uppercase;
  color:var(--muted);
}
.field input {
  border:0;
  background:transparent;
  padding:0;
  min-height:46px;
  outline:none;
}
.field input::placeholder { color:rgba(230,234,242,.6); }
.checks {
  display:flex;
  flex-wrap:wrap;
  gap:14px;
}
.checks label {
  display:inline-flex;
  align-items:center;
  gap:10px;
  padding:10px 16px;
  border-radius:var(--radius-md);
  border:1px solid var(--stroke);
  background:var(--panel);
  font-weight:600;
}
.checks input[type="checkbox"] {
  appearance:none;
  width:20px;
  height:20px;
  border-radius:6px;
  border:1px solid var(--stroke);
  background:var(--bg);
  position:relative;
  transition:background .18s ease,border-color .18s ease;
}
.checks input[type="checkbox"]:checked {
  background:var(--accent);
  border-color:var(--accent);
}
.checks input[type="checkbox"]:checked::after {
  content:'';
  position:absolute;
  left:4px;
  top:2px;
  width:10px;
  height:14px;
  border:2px solid #fff;
  border-top:0;
  border-left:0;
  transform:rotate(45deg);
}
.actions {
  display:flex;
  flex-wrap:wrap;
  gap:10px;
}
.actions button {
  flex:1 1 180px;
  min-height:46px;
  border-radius:var(--radius-md);
  border:1px solid transparent;
  background:var(--panel);
  color:var(--text);
  font-weight:600;
  letter-spacing:.01em;
  transition:background .18s ease,border-color .18s ease,transform .18s ease;
}
.actions button.primary { background:var(--accent); border-color:var(--accent); color:#fff; }
.actions button:hover:not(:disabled),
.actions button:focus-visible {
  background:var(--panel-soft);
  border-color:rgba(225,29,46,.5);
  outline:none;
}
.actions button.primary:hover:not(:disabled),
.actions button.primary:focus-visible {
  background:var(--accent-hover);
  border-color:var(--accent-hover);
}
.actions button:active:not(:disabled) { transform:translateY(1px); }
.actions button:disabled { opacity:.55; cursor:not-allowed; }
main { flex:1; position:relative; min-height:60vh; }
#map {
  position:absolute;
  inset:0;
  background:#050608;
}
#routeList {
  position:absolute;
  right:24px;
  top:148px;
  width:300px;
  max-width:calc(100vw - 32px);
  max-height:calc(100vh - 220px);
  overflow-y:auto;
  padding:16px;
  border-radius:var(--radius-lg);
  border:1px solid var(--stroke);
  background:var(--panel-soft);
  box-shadow:var(--shadow);
  display:none;
  z-index:20;
  backdrop-filter:blur(10px);
}
.routeItem {
  padding:12px;
  border-radius:var(--radius-md);
  border:1px solid transparent;
  display:flex;
  flex-direction:column;
  gap:6px;
  cursor:pointer;
  transition:background .18s ease,border-color .18s ease;
}
.routeItem:hover,
.routeItem:focus-visible { background:var(--panel); outline:none; }
.routeItem.active {
  border-color:var(--accent);
  background:rgba(225,29,46,.12);
}
.routeItem .title { font-weight:600; }
.routeItem .meta { color:var(--muted); font-size:13px; }
.legend {
  position:absolute;
  left:24px;
  bottom:24px;
  display:flex;
  gap:18px;
  align-items:center;
  padding:12px 18px;
  border-radius:var(--radius-lg);
  border:1px solid var(--stroke);
  background:var(--panel-soft);
  box-shadow:var(--shadow);
  font-size:13px;
  z-index:12;
}
.legend .item { display:flex; align-items:center; gap:8px; }
.legend .dot {
  width:12px;
  height:12px;
  border-radius:50%;
  box-shadow:0 0 0 1px rgba(0,0,0,.35);
}
#toast {
  position:fixed;
  right:24px;
  bottom:24px;
  padding:16px 20px;
  border-radius:var(--radius-lg);
  border:1px solid var(--stroke);
  background:var(--panel-soft);
  max-width:360px;
  box-shadow:var(--shadow);
  color:var(--text);
  display:flex;
  gap:12px;
  opacity:0;
  pointer-events:none;
  transform:translateY(18px);
  transition:opacity .24s ease,transform .24s ease;
  z-index:60;
}
#toast.show { opacity:1; pointer-events:auto; transform:translateY(0); }
#toast[data-tone="error"] { border-color:var(--accent); background:rgba(225,29,46,.16); }
#toast[data-tone="success"] { border-color:var(--success); background:rgba(34,197,94,.16); }
#toast[data-tone="warning"] { border-color:var(--warning); background:rgba(245,158,11,.16); }
#toast strong { font-weight:600; }
body.is-grabbing, body.is-grabbing * { cursor:grabbing!important; }

@media (max-width:1024px) {
  #routeList { right:16px; top:auto; bottom:120px; max-height:42vh; }
  .legend { left:16px; bottom:16px; flex-wrap:wrap; row-gap:10px; }
  #toast { left:16px; right:16px; bottom:16px; max-width:none; }
}
@media (max-width:780px) {
  .fields { grid-template-columns:1fr; }
  .actions { flex-direction:column; }
  .actions button { flex:1 1 auto; }
}
::-webkit-scrollbar { width:8px; height:8px; }
::-webkit-scrollbar-thumb { background:rgba(137,148,172,.55); border-radius:999px; }
::-webkit-scrollbar-track { background:rgba(35,40,54,.6); }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="bar">
      <div class="brand">
        <img src="../assets/logo-tt.svg" alt="Trans-Time" width="34" height="34" loading="lazy">
        <span>Trans-Time ‚Ä¢ –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –≥—Ä—É–∑–æ–≤–∏–∫–æ–≤</span>
      </div>
      <div class="small-note">–ö–ª–∏–∫ –ø–æ –∫–∞—Ä—Ç–µ –¥–æ–±–∞–≤–∏—Ç via-—Ç–æ—á–∫—É –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è ‚Ä¢ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã —Å–ø—Ä–∞–≤–∞</div>
      <div id="apiBanner" class="api-banner" role="alert"></div>
      <div class="controls">
        <div class="fields">
          <div class="field">
            <label for="from">–û—Ç–∫—É–¥–∞</label>
            <input id="from" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å" autocomplete="off" spellcheck="false">
          </div>
          <div class="field">
            <label for="to">–ö—É–¥–∞</label>
            <input id="to" type="text" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –∞–¥—Ä–µ—Å" autocomplete="off" spellcheck="false">
          </div>
        </div>
        <div class="checks">
          <label><input id="avoidTolls" type="checkbox"> –ò–∑–±–µ–≥–∞—Ç—å –ø–ª–∞—Ç–Ω—ã—Ö</label>
          <label><input id="detourFrames" type="checkbox"> –û–±—ä–µ–∑–¥ —Ä–∞–º–æ–∫</label>
          <label><input id="showFrames" type="checkbox" checked> –í–µ—Å–æ–≤—ã–µ —Ä–∞–º–∫–∏</label>
        </div>
        <div class="actions">
          <button id="buildBtn" type="button" class="primary">–ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç</button>
          <button id="geoBtn" type="button">üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
          <button id="swapBtn" type="button">‚ÜïÔ∏è –ü–æ–º–µ–Ω—è—Ç—å</button>
          <button id="clearViaBtn" type="button">–°–±—Ä–æ—Å–∏—Ç—å via-—Ç–æ—á–∫–∏</button>
        </div>
      </div>
    </div>
  </header>
  <main>
    <div id="map" role="presentation"></div>
    <aside id="routeList" aria-label="–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã"></aside>
    <div class="legend">
      <div class="item"><span class="dot" style="background:#22c55e"></span>–ê–∫—Ç–∏–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</div>
      <div class="item"><span class="dot" style="background:#f59e0b"></span>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã</div>
      <div class="item"><span class="dot" style="background:#60a5fa"></span>–í–µ—Å–æ–≤—ã–µ —Ä–∞–º–∫–∏</div>
    </div>
  </main>
</div>
<div id="toast" role="status" aria-live="polite"></div>
<script>
(() => {
  'use strict';

  const API_KEYS = [
    '317aa42d-aa15-4acf-885a-6d6bfddb2339',
    '51b700f9-a6af-4723-b874-b1a8541b684b'
  ];
  const API_NAMESPACE = 'ymapsTT';
  const API_URL_BASE = 'https://api-maps.yandex.ru/2.1/?lang=ru_RU&ns=' + API_NAMESPACE + '&load=package.standard,package.search,package.suggest&apikey=';
  const API_TIMEOUT = 9000;
  const REQUIRED_PATHS = [
    ['Map'],
    ['multiRouter','MultiRoute'],
    ['ObjectManager'],
    ['SuggestView'],
    ['geocode']
  ];

  const doc = document;
  const mapEl = doc.getElementById('map');
  const routeListEl = doc.getElementById('routeList');
  const toastEl = doc.getElementById('toast');
  const apiBannerEl = doc.getElementById('apiBanner');
  const fromInput = doc.getElementById('from');
  const toInput = doc.getElementById('to');
  const buildBtn = doc.getElementById('buildBtn');
  const geoBtn = doc.getElementById('geoBtn');
  const swapBtn = doc.getElementById('swapBtn');
  const clearViaBtn = doc.getElementById('clearViaBtn');
  const avoidTollsCheckbox = doc.getElementById('avoidTolls');
  const detourCheckbox = doc.getElementById('detourFrames');
  const framesCheckbox = doc.getElementById('showFrames');

  console.log('[TEST] DOM:#map OK');
  if(fromInput && toInput){
    console.log('[TEST] Inputs OK');
  }
  if(typeof window.L === 'undefined'){
    console.log('[TEST] No Leaflet ‚Äî OK');
  }

  const tests = {
    toastShown:false,
    suggestBound:false,
    multiRoute:false
  };

  let scriptNode = null;
  let apiTimeoutId = null;
  let currentKeyIndex = 0;
  let loading = false;
  let ymapsApi = null;

  const state = {
    map:null,
    multiRoute:null,
    objectManager:null,
    suggestFrom:null,
    suggestTo:null,
    framePoints:[],
    framesVisible:true,
    viaPoints:[],
    viaPlacemarks:[],
    autoDetour:false,
    activeKeyNumber:0
  };

  const notifications = (() => {
    let timer = 0;
    return {
      show(message, duration = 4200, tone = 'info') {
        if(!toastEl) return;
        toastEl.innerHTML = message;
        toastEl.dataset.tone = tone;
        toastEl.classList.add('show');
        window.clearTimeout(timer);
        timer = window.setTimeout(() => {
          toastEl.classList.remove('show');
        }, duration);
        if(!tests.toastShown && tone !== 'error'){
          console.log('[TEST] Toast OK ‚Äî –ø–æ–∫–∞–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞');
          tests.toastShown = true;
        }
      },
      hide(){
        if(!toastEl) return;
        toastEl.classList.remove('show');
      }
    };
  })();

  const formatDistance = (value) => {
    if(!Number.isFinite(value) || value <= 0) return '‚Äî';
    const km = value / 1000;
    return (km >= 100 ? km.toFixed(0) : km.toFixed(1)).replace('.', ',') + ' –∫–º';
  };

  const formatDuration = (value) => {
    if(!Number.isFinite(value) || value <= 0) return '‚Äî';
    const hours = Math.floor(value / 3600);
    const minutes = Math.round((value % 3600) / 60);
    if(hours > 0){
      return `${hours} —á ${minutes.toString().padStart(2,'0')} –º–∏–Ω`;
    }
    return `${minutes} –º–∏–Ω`;
  };

  const escapeMap = {
    '&':'&amp;',
    '<':'&lt;',
    '>':'&gt;',
    '"':'&quot;',
    "'":'&#39;'
  };
  const escapeHtml = (str) => String(str ?? '').replace(/[&<>"']/g, (ch) => escapeMap[ch] ?? ch);

  function setControlsDisabled(disabled){
    [buildBtn, geoBtn, swapBtn, clearViaBtn, avoidTollsCheckbox, detourCheckbox, framesCheckbox, fromInput, toInput].forEach((el) => {
      if(!el) return;
      if('disabled' in el){ el.disabled = !!disabled; }
    });
  }

  function showApiBanner(message, details){
    if(!apiBannerEl) return;
    apiBannerEl.innerHTML = `<strong>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ API –Ø–Ω–¥–µ–∫—Å (CSP/–±–∞–Ω–¥–ª)</strong><br>${escapeHtml(message)}${details ? `<div style='margin-top:6px;color:var(--muted)'>${escapeHtml(details)}</div>` : ''}`;
    apiBannerEl.classList.add('show');
  }

  function hideApiBanner(){
    if(apiBannerEl){
      apiBannerEl.classList.remove('show');
      apiBannerEl.textContent = '';
    }
  }

  function cleanupScript(){
    if(scriptNode && scriptNode.parentNode){
      scriptNode.parentNode.removeChild(scriptNode);
    }
    scriptNode = null;
    if(apiTimeoutId){
      window.clearTimeout(apiTimeoutId);
      apiTimeoutId = null;
    }
    if(window[API_NAMESPACE]){
      try { delete window[API_NAMESPACE]; }
      catch (e) { window[API_NAMESPACE] = undefined; }
    }
  }

  function verifyModules(ns){
    const missing = [];
    REQUIRED_PATHS.forEach((path) => {
      let ref = ns;
      for(const part of path){
        ref = ref && ref[part];
      }
      if(!ref){
        missing.push(path.join('.'));
      }
    });
    return missing;
  }

  function handleApiFailure(reason){
    cleanupScript();
    loading = false;
    if(currentKeyIndex + 1 < API_KEYS.length){
      console.warn('–ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–ª—é—á API, –ø—Ä–∏—á–∏–Ω–∞:', reason);
      currentKeyIndex += 1;
      loadApi();
    } else {
      showApiBanner('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å JavaScript API –Ø–Ω–¥–µ–∫—Å–∞.', '–î–æ–±–∞–≤—å—Ç–µ –≤ Content-Security-Policy –¥–æ–º–µ–Ω—ã api-maps.yandex.ru, *.yastatic.net, *.yandex.net –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ unsafe-eval.');
      notifications.show('API –Ø–Ω–¥–µ–∫—Å –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∫–∞—Ä—Ç—ã –æ—Ç–∫–ª—é—á–µ–Ω.', 6000, 'error');
      setControlsDisabled(true);
    }
  }

  function loadApi(){
    if(loading) return;
    hideApiBanner();
    setControlsDisabled(true);
    loading = true;
    const key = API_KEYS[currentKeyIndex];
    if(!key){
      handleApiFailure('no-key');
      return;
    }
    cleanupScript();
    scriptNode = doc.createElement('script');
    scriptNode.src = API_URL_BASE + encodeURIComponent(key);
    scriptNode.async = true;
    scriptNode.onerror = () => handleApiFailure('script-error');
    const start = Date.now();
    scriptNode.addEventListener('load', () => {
      pollNamespace(start);
    });
    doc.head.appendChild(scriptNode);
    apiTimeoutId = window.setTimeout(() => handleApiFailure('timeout'), API_TIMEOUT);
  }

  function pollNamespace(start){
    if(!loading) return;
    const ns = window[API_NAMESPACE];
    if(ns && typeof ns.ready === 'function'){
      ns.ready(() => {
        window.clearTimeout(apiTimeoutId);
        apiTimeoutId = null;
        const missing = verifyModules(ns);
        if(missing.length){
          handleApiFailure('missing:' + missing.join(','));
          return;
        }
        onApiReady(ns);
      });
      return;
    }
    if(Date.now() - start > API_TIMEOUT){
      handleApiFailure('namespace-timeout');
      return;
    }
    window.setTimeout(() => pollNamespace(start), 160);
  }

  function onApiReady(ns){
    loading = false;
    ymapsApi = ns;
    state.activeKeyNumber = currentKeyIndex + 1;
    setControlsDisabled(false);
    initMap();
    console.log(`[TEST] API ready OK (key=${state.activeKeyNumber})`);
    runSmokeMultiRoute();
  }

  function initMap(){
    if(!mapEl) return;
    state.map = new ymapsApi.Map('map', {
      center:[55.751244,37.618423],
      zoom:9,
      controls:['zoomControl','fullscreenControl','typeSelector']
    }, {
      suppressMapOpenBlock:true
    });

    if(state.map && state.map.cursors){
      state.map.cursors.push('grab');
      state.map.events.add('actionbegin', (event) => {
        if(event.get('type') === 'drag'){
          document.body.classList.add('is-grabbing');
        }
      });
      state.map.events.add('actionend', () => document.body.classList.remove('is-grabbing'));
      document.addEventListener('mouseup', () => document.body.classList.remove('is-grabbing'));
    }

    bindSuggests();
    bindUiEvents();
    loadFrames();
  }

  function bindSuggests(){
    const config = { results:8, minChars:1, width:'auto' };
    state.suggestFrom = new ymapsApi.SuggestView('from', config);
    state.suggestTo = new ymapsApi.SuggestView('to', config);
    if(state.suggestFrom && state.suggestTo && !tests.suggestBound){
      tests.suggestBound = true;
      console.log('[TEST] SuggestView bound OK');
    }
    if(state.suggestFrom){
      state.suggestFrom.events.add('select', () => autoBuild());
    }
    if(state.suggestTo){
      state.suggestTo.events.add('select', () => autoBuild());
    }
  }

  function bindUiEvents(){
    if(state.map){
      state.map.events.add('click', (event) => {
        const coords = event.get('coords');
        if(!coords) return;
        const label = `${coords[0].toFixed(6)}, ${coords[1].toFixed(6)}`;
        if(window.confirm(`–î–æ–±–∞–≤–∏—Ç—å via-—Ç–æ—á–∫—É?\n${label}`)){
          state.viaPoints.push(coords);
          const placemark = new ymapsApi.Placemark(coords, {hintContent:'via-—Ç–æ—á–∫–∞'}, {preset:'islands#blueCircleIcon', iconColor:'#60a5fa'});
          state.viaPlacemarks.push(placemark);
          state.map.geoObjects.add(placemark);
          notifications.show('–î–æ–±–∞–≤–ª–µ–Ω–∞ via-—Ç–æ—á–∫–∞', 3200, 'success');
          autoBuild();
        }
      });
    }

    if(buildBtn){
      buildBtn.addEventListener('click', () => buildRoute().catch((err) => console.warn(err)));
    }
    if(swapBtn){
      swapBtn.addEventListener('click', () => {
        const fromVal = fromInput.value;
        fromInput.value = toInput.value;
        toInput.value = fromVal;
        autoBuild();
      });
    }
    if(clearViaBtn){
      clearViaBtn.addEventListener('click', () => {
        state.viaPoints = [];
        while(state.viaPlacemarks.length){
          const placemark = state.viaPlacemarks.pop();
          if(placemark && state.map){
            state.map.geoObjects.remove(placemark);
          }
        }
        notifications.show('Via-—Ç–æ—á–∫–∏ –æ—á–∏—â–µ–Ω—ã', 2800, 'info');
        autoBuild();
      });
    }
    if(geoBtn){
      geoBtn.addEventListener('click', locateUser);
    }
    if(detourCheckbox){
      detourCheckbox.addEventListener('change', () => {
        state.autoDetour = detourCheckbox.checked;
        if(state.autoDetour && !framePointsReady()){
          notifications.show('–î–ª—è –æ–±—ä–µ–∑–¥–∞ —Ä–∞–º–æ–∫ —Ç—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ—á–µ–∫.', 4200, 'warning');
        }
        autoBuild();
      });
    }
    if(framesCheckbox){
      framesCheckbox.addEventListener('change', () => {
        state.framesVisible = framesCheckbox.checked;
        applyFramesVisibility();
      });
    }
  }

  async function locateUser(){
    if(!navigator.geolocation){
      notifications.show('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è.', 4600, 'warning');
      return;
    }
    geoBtn.disabled = true;
    geoBtn.textContent = '‚åõ –û–ø—Ä–µ–¥–µ–ª—è–µ–º‚Ä¶';
    navigator.geolocation.getCurrentPosition(async (position) => {
      try {
        const coords = [position.coords.latitude, position.coords.longitude];
        if(state.map){
          state.map.setCenter(coords, Math.max(state.map.getZoom(), 12), {duration:300});
        }
        const result = await ymapsApi.geocode(coords, {results:1});
        const geoObject = result.geoObjects.get(0);
        const address = geoObject ? (typeof geoObject.getAddressLine === 'function' ? geoObject.getAddressLine() : geoObject.get('text')) : '';
        if(address){
          fromInput.value = address;
          notifications.show(`üìç <strong>–û—Ç–∫—É–¥–∞:</strong> ${escapeHtml(address)}`, 5600, 'success');
          autoBuild();
        } else {
          notifications.show('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.', 5200, 'error');
        }
      } catch (error) {
        console.warn(error);
        notifications.show('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.', 5200, 'error');
      } finally {
        geoBtn.disabled = false;
        geoBtn.textContent = 'üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
      }
    }, (error) => {
      console.warn(error);
      geoBtn.disabled = false;
      geoBtn.textContent = 'üìç –ú–æ—ë –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ';
      notifications.show('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.', 5200, 'error');
    }, { enableHighAccuracy:true, timeout:15000, maximumAge:60000 });
  }

  function autoBuild(){
    if(fromInput.value.trim() && toInput.value.trim()){
      buildRoute().catch((err) => console.warn(err));
    }
  }

  async function geocodePoint(value){
    const trimmed = value.trim();
    if(!trimmed){
      throw new Error('–ê–¥—Ä–µ—Å –ø—É—Å—Ç');
    }
    const result = await ymapsApi.geocode(trimmed, {results:1});
    const geoObject = result.geoObjects.get(0);
    if(!geoObject){
      throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω –∞–¥—Ä–µ—Å: ' + trimmed);
    }
    const coords = geoObject.geometry.getCoordinates();
    return { coords, meta:geoObject.properties.getAll() };
  }

  async function buildRoute(){
    if(!ymapsApi || !state.map){
      throw new Error('API –Ω–µ –≥–æ—Ç–æ–≤');
    }
    const fromValue = fromInput.value.trim();
    const toValue = toInput.value.trim();
    if(!fromValue || !toValue){
      notifications.show('–£–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.', 4200, 'warning');
      return;
    }

    try {
      const [fromPoint, toPoint] = await Promise.all([
        geocodePoint(fromValue),
        geocodePoint(toValue)
      ]);

      let referencePoints = [fromPoint.coords, ...state.viaPoints, toPoint.coords];
      if(state.autoDetour && framePointsReady()){
        const detourResult = injectDetours(referencePoints.map((coords) => coords.slice()));
        referencePoints = detourResult.points;
        if(detourResult.names.length){
          detourResult.names.forEach((name) => {
            notifications.show(`–û–±—ä–µ–∑–¥ –≤–µ—Å–æ–≤–æ–π —Ä–∞–º–∫–∏ —É ${escapeHtml(name)}`, 4200, 'warning');
          });
        }
      }

      const params = { results:3 };
      if(avoidTollsCheckbox.checked){
        params.avoidTollRoads = true;
      }

      if(!state.multiRoute){
        state.multiRoute = new ymapsApi.multiRouter.MultiRoute({
          referencePoints,
          params
        }, {
          boundsAutoApply:true,
          zoomMargin:[40,40,40,40],
          routeActiveStrokeColor:'#22c55e',
          routeActiveStrokeWidth:6,
          routeActiveStrokeStyle:'solid',
          routeStrokeColor:'#f59e0b',
          routeStrokeWidth:5,
          routeStrokeStyle:'dash'
        });
        state.map.geoObjects.add(state.multiRoute);
        state.multiRoute.model.events.add('requestsuccess', handleRouteSuccess);
        state.multiRoute.model.events.add('requestfail', () => {
          notifications.show('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å–∞.', 5200, 'error');
        });
        state.multiRoute.events.add('activeroutechange', handleActiveRouteChange);
      } else {
        state.multiRoute.model.setReferencePoints(referencePoints);
        state.multiRoute.model.setParams(params, true);
      }

      routeListEl.innerHTML = '<div class="small-note">–°—Ç—Ä–æ–∏–º –º–∞—Ä—à—Ä—É—Ç‚Ä¶</div>';
      routeListEl.style.display = 'block';
    } catch (error) {
      console.warn(error);
      notifications.show('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∞–¥—Ä–µ—Å–∞.', 5200, 'error');
      throw error;
    }
  }

  function handleRouteSuccess(){
    updateRouteList();
    handleActiveRouteChange();
    if(!tests.multiRoute){
      const routes = state.multiRoute && state.multiRoute.getRoutes();
      const count = routes ? routes.getLength() : 0;
      console.log(`[TEST] MultiRoute OK ‚Äî –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤: ${count}`);
      tests.multiRoute = true;
    }
  }

  function handleActiveRouteChange(){
    if(!state.multiRoute) return;
    const activeRoute = state.multiRoute.getActiveRoute();
    if(!activeRoute) return;
    const props = activeRoute.properties.getAll();
    notifications.show(`<strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> ${formatDistance(props?.distance?.value)} ‚Ä¢ ${formatDuration(props?.duration?.value)}`, 6400, 'info');
  }

  function updateRouteList(){
    if(!state.multiRoute){
      routeListEl.style.display = 'none';
      return;
    }
    const routes = state.multiRoute.getRoutes();
    if(!routes || routes.getLength() === 0){
      routeListEl.style.display = 'none';
      notifications.show('–ú–∞—Ä—à—Ä—É—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω.', 3800, 'warning');
      return;
    }
    routeListEl.innerHTML = '';
    const activeRoute = state.multiRoute.getActiveRoute();
    const length = routes.getLength();
    for(let i = 0; i < length; i += 1){
      const route = routes.get(i);
      const props = route.properties.getAll();
      const item = doc.createElement('div');
      const isActive = route === activeRoute;
      item.className = 'routeItem' + (isActive ? ' active' : '');
      item.setAttribute('role', 'button');
      item.setAttribute('tabindex', '0');
      item.innerHTML = `<div class='title'>–í–∞—Ä–∏–∞–Ω—Ç ${i + 1}</div><div class='meta'>${formatDistance(props?.distance?.value)} ‚Ä¢ ${formatDuration(props?.duration?.value)}</div>`;
      const activate = () => {
        if(state.multiRoute){
          state.multiRoute.setActiveRoute(route);
          handleActiveRouteChange();
          updateRouteList();
        }
      };
      item.addEventListener('click', activate);
      item.addEventListener('keydown', (event) => {
        if(event.key === 'Enter' || event.key === ' '){
          event.preventDefault();
          activate();
        }
      });
      routeListEl.appendChild(item);
    }
    routeListEl.style.display = 'block';
  }

  function framePointsReady(){
    return Array.isArray(state.framePoints) && state.framePoints.length > 0;
  }

  async function loadFrames(){
    try {
      const response = await fetch('./data/frames_ready.geojson?v=' + Date.now(), {cache:'no-store'});
      if(!response.ok){
        throw new Error('frames_ready.geojson not found');
      }
      const data = await response.json();
      state.framePoints = [];
      if(state.objectManager && state.map){
        state.map.geoObjects.remove(state.objectManager);
      }
      state.objectManager = new ymapsApi.ObjectManager({ clusterize:false, geoObjectOpenBalloonOnClick:true });
      state.objectManager.objects.options.set({ preset:'islands#blueCircleDotIcon', iconColor:'#60a5fa' });
      if(Array.isArray(data?.features)){
        const features = [];
        data.features.forEach((feature, index) => {
          if(feature?.geometry?.type !== 'Point' || !Array.isArray(feature.geometry.coordinates)) return;
          const [lon, lat] = feature.geometry.coordinates;
          if(!Number.isFinite(lat) || !Number.isFinite(lon)) return;
          const props = feature.properties || {};
          const name = props.name || props.title || `–†–∞–º–∫–∞ ‚Ññ${index + 1}`;
          const comment = props.comment ? `<div style='margin-top:6px'>${escapeHtml(props.comment)}</div>` : '';
          const date = props.date ? `<div class='small-note' style='margin-top:6px;color:#9aa3b2'>–î–∞—Ç–∞: ${escapeHtml(props.date)}</div>` : '';
          feature.properties = {
            hintContent:name,
            balloonContent:`<div style='min-width:220px'><strong>${escapeHtml(name)}</strong>${comment}${date}</div>`
          };
          features.push(feature);
          state.framePoints.push({ coords:[lat, lon], name });
        });
        state.objectManager.add({ type:'FeatureCollection', features });
      }
      applyFramesVisibility();
      console.log(`[TEST] Frames loaded OK (${state.framePoints.length})`);
      if(state.framePoints.length === 0){
        notifications.show('–í–µ—Å–æ–≤—ã–µ —Ä–∞–º–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.', 4200, 'warning');
      }
    } catch (error) {
      console.warn(error);
      notifications.show('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –≤–µ—Å–æ–≤—ã–µ —Ä–∞–º–∫–∏.', 4800, 'error');
    }
  }

  function applyFramesVisibility(){
    if(!state.map || !state.objectManager) return;
    if(state.framesVisible){
      if(!state.map.geoObjects.contains(state.objectManager)){
        state.map.geoObjects.add(state.objectManager);
      }
    } else {
      if(state.map.geoObjects.contains(state.objectManager)){
        state.map.geoObjects.remove(state.objectManager);
      }
    }
  }

  function injectDetours(points){
    const projection = ymapsApi.projection.wgs84Mercator;
    const insertedNames = [];
    state.framePoints.forEach((frame) => {
      if(!Array.isArray(frame.coords)) return;
      const nearest = findNearestSegment(points, frame.coords, projection);
      if(!nearest || !Number.isFinite(nearest.distance) || nearest.distance > 120) return;
      const azimuth = nearest.azimuth;
      const candidates = [azimuth + 90, azimuth - 90];
      let chosen = null;
      let bestSpacing = -Infinity;
      candidates.forEach((angle) => {
        const normalized = normalizeAzimuth(angle);
        const candidate = ymapsApi.coordSystem.geo.solveDirectProblem(frame.coords, normalized, 200).endPoint;
        const spacing = ymapsApi.coordSystem.geo.getDistance(candidate, frame.coords);
        if(spacing > bestSpacing){
          bestSpacing = spacing;
          chosen = candidate;
        }
      });
      if(!chosen) return;
      points.splice(nearest.index + 1, 0, chosen);
      insertedNames.push(frame.name);
    });
    return { points, names:insertedNames };
  }

  function findNearestSegment(points, target, projection){
    if(points.length < 2) return null;
    const targetGlobal = projection.toGlobal(target);
    let best = null;
    for(let i = 0; i < points.length - 1; i += 1){
      const start = points[i];
      const end = points[i + 1];
      const startGlobal = projection.toGlobal(start);
      const endGlobal = projection.toGlobal(end);
      const vx = endGlobal[0] - startGlobal[0];
      const vy = endGlobal[1] - startGlobal[1];
      const lengthSq = vx * vx + vy * vy;
      if(lengthSq === 0) continue;
      const px = targetGlobal[0] - startGlobal[0];
      const py = targetGlobal[1] - startGlobal[1];
      let t = (px * vx + py * vy) / lengthSq;
      t = Math.max(0, Math.min(1, t));
      const projGlobal = [startGlobal[0] + vx * t, startGlobal[1] + vy * t];
      const projGeo = projection.fromGlobal(projGlobal);
      const distance = ymapsApi.coordSystem.geo.getDistance(target, projGeo);
      if(!Number.isFinite(distance)) continue;
      if(!best || distance < best.distance){
        const info = ymapsApi.coordSystem.geo.solveInverseProblem(start, end);
        best = { distance, index:i, azimuth:info.forwardAzimuth };
      }
    }
    return best;
  }

  function normalizeAzimuth(value){
    let v = value % 360;
    if(v < 0) v += 360;
    return v;
  }

  function runSmokeMultiRoute(){
    if(!ymapsApi) return;
    const testRoute = new ymapsApi.multiRouter.MultiRoute({
      referencePoints:['–ú–æ—Å–∫–≤–∞', '–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥'],
      params:{ results:3 }
    }, { boundsAutoApply:false });
    const cleanup = () => {
      if(testRoute && testRoute.destroy){
        testRoute.destroy();
      }
    };
    testRoute.model.events.add('requestsuccess', () => {
      const routes = testRoute.getRoutes();
      const count = routes ? routes.getLength() : 0;
      console.log(`[TEST] MultiRoute OK ‚Äî –ú–æ—Å–∫–≤–∞ ‚Üí –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ (${count})`);
      cleanup();
    });
    testRoute.model.events.add('requestfail', () => {
      console.warn('–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç –Ω–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω');
      cleanup();
    });
  }

  loadApi();
})();
</script>
</body>
</html>
